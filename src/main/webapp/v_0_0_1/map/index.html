<!DOCTYPE html>
<html lang="sv">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Evengemang i Helsingborg</title>

  <link href="leaflet-0.7.7/leaflet.css" media="screen" rel="stylesheet">
  <script src="leaflet-0.7.7/leaflet-src.js"></script>

  <style>

    html, body, div, span, textarea, button, input, table, tr, td {
      font-family: arial, helvetica, sans-serif;
      font-size: 13px
    }

    body {
      padding: 0;
      margin: 0;
    }

    html, body, #map {
      height: 100%;
      width: 100%;
    }


  </style>

</head>
<body>

<div id="map"></div>

<script>

  var attribution = 'Kartdata och kartbilder från <a href="http://www.openstreetmap.se">OpenStreetMap Sverige</a>. Kart-API från <a href="http://leafletjs.org">Leaflet</a>.';

  var full = new L.TileLayer('http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png', {
    subdomains: "abc",
    attribution: attribution,
    maxZoom: 18,
    detectRetina: false
  });

  var map = new L.Map('map');
  map.attributionControl.options.prefix = '';

  map.addLayer(full);

  //  var swedenSouthWest = L.latLng(50, 11),
  //      swedenNorthEast = L.latLng(70, 25),
  //      swedenBounds = L.latLngBounds(swedenSouthWest, swedenNorthEast);
  //  map.fitBounds(swedenBounds);

  var helsingborgSouthWest = L.latLng(55.96, 12.65),
      helsingborgNorthEast = L.latLng(56.13, 12.87),
      helsingborgBounds = L.latLngBounds(helsingborgSouthWest, helsingborgNorthEast);
  map.fitBounds(helsingborgBounds);


  search();


  var delayedSearchTimeout = null;
  function delayedSearch(millisecondsDelay) {
    if (delayedSearchTimeout) {
      window.clearTimeout(delayedSearchTimeout);
    }
    delayedSearchTimeout = window.setTimeout(function () {
      search();
    }, millisecondsDelay);
  }

  function search() {
    if (delayedSearchTimeout) {
      window.clearTimeout(delayedSearchTimeout);
      delayedSearchTimeout = null;
    }

    executeQuery(searchRequestFactory());
  }


  var expectedReference = null;


  function searchRequestFactory() {

    var searchRequest = {
      reference : createRandomUUID(),
      limit : 100000,
      startIndex : 0,
      query : {
        type : "event location coordinate envelope",
        southLatitude: map.getBounds().getSouth(),
        westLongitude: map.getBounds().getWest(),
        northLatitude: map.getBounds().getNorth(),
        eastLongitude: map.getBounds().getEast()
      }
    };

    return searchRequest;
  }


  function executeQuery(searchRequest) {

    expectedReference = searchRequest.reference;

    var httpRequest = new XMLHttpRequest();
    httpRequest.open("post", "/v_0_0_1/event/search", true);
    httpRequest.onreadystatechange = function () {
      if (httpRequest.readyState == 4) {
        if (httpRequest.status == 200) {
          var timestampReceived = new Date();
          var searchResults = JSON.parse(httpRequest.responseText);
          searchResults.timestampReceived = timestampReceived;

          if (searchResults.reference == expectedReference) {
            processSearchResults(searchRequest, searchResults);
          } else {
            console.log("Ignoring non expected search results, probably due to old response taking a long time.")
          }


        } else {
          // todo notify user of error
          console.log(httpRequest.status + "\n" + httpRequest.responseText);
        }
      }
    };
    httpRequest.send(JSON.stringify(searchRequest));

  }

  function processSearchResults(searchRequest, searchResults) {

  }


  function createRandomUUID() {
    // http://www.ietf.org/rfc/rfc4122.txt
    var s = [];
    var hexDigits = "0123456789abcdef";
    for (var i = 0; i < 36; i++) {
      s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    }
    s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
    s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
    s[8] = s[13] = s[18] = s[23] = "-";

    return s.join("");
  }


</script>

</body>
</html>